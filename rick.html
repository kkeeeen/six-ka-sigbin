<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Video (local)</title>
    <style>
      html,body{height:100%;margin:0;background:#000}
      .player-wrap{position:fixed;inset:0;display:flex;align-items:center;justify-content:center}
      .player{width:min(100%,1200px);height:min(56.25vw,720px);max-height:100%;background:#000}
      .overlay{position:fixed;inset:0;display:flex;align-items:center;justify-content:center;pointer-events:none}
      .play-btn{pointer-events:auto;background:rgba(0,0,0,0.6);color:#fff;border:0;padding:12px 18px;border-radius:8px;font-size:16px;cursor:pointer}
      .muted-note{position:fixed;left:12px;bottom:12px;color:#fff;font-size:13px;opacity:0.95}
    </style>
  </head>
  <body>
    <div class="player-wrap">
      <!-- Local video visually, MP3 provides audible audio -->
      <video id="player" class="player" playsinline autoplay muted>
        <source src="videos/video.mp4" type="video/mp4">
        Your browser does not support HTML5 video.
      </video>
      <audio id="audio" src="videos/audio.mp3" loop></audio>
    </div>

    <div class="overlay">
      <button id="playBtn" class="play-btn">Play ▶</button>
      <div class="muted-note">If audio doesn't start, click Play</div>
    </div>

    <script>
      (function(){
        const video = document.getElementById('player');
        const audio = document.getElementById('audio');
        const btn = document.getElementById('playBtn');

        let userStarted = false;

        function setBtn(paused){
          btn.textContent = paused ? 'Play ▶' : 'Pause ⏸';
        }

        async function tryAutoStart(){
          // Attempt autoplay (may be blocked); show control regardless
          try{ video.loop = true; await video.play(); }catch(e){}
          try{ await audio.play(); audio.pause(); }catch(e){}
          setBtn(true);
        }

        async function startPlayback(){
          try{
            // align audio to video then play both
            if (!isFinite(video.currentTime)) video.currentTime = 0;
            audio.currentTime = video.currentTime;
            await Promise.all([video.play().catch(()=>{}), audio.play().catch(()=>{})]);
            audio.muted = false;
            userStarted = true;
            setBtn(false);
            // remove the play button after user presses it
            try{ btn.style.display = 'none'; }catch(e){}
          }catch(e){ console.warn(e); }
        }

        async function pausePlayback(){
          try{ video.pause(); audio.pause(); userStarted = false; setBtn(true);}catch(e){}
        }

        btn.addEventListener('click', function(){
          if (video.paused || audio.paused || !userStarted) startPlayback();
          else pausePlayback();
        });

        // Sync loop: small playbackRate nudges when drift small, jump when large
        function syncLoop(){
          try{
            const d = video.currentTime - audio.currentTime;
            const absd = Math.abs(d);
            if (absd > 0.5){
              // big drift -> snap
              audio.currentTime = video.currentTime;
              audio.playbackRate = 1;
            } else if (absd > 0.02){
              // small drift -> gently nudge audio playbackRate
              // scale factor small: d positive -> audio behind -> increase rate
              let rate = 1 + (d * 0.1);
              rate = Math.max(0.95, Math.min(1.05, rate));
              audio.playbackRate = rate;
            } else {
              audio.playbackRate = 1;
            }
          }catch(e){}
          requestAnimationFrame(syncLoop);
        }

        // Keep the button label in sync with playback state (do not auto-hide)
        video.addEventListener('play', ()=> setBtn(false));
        audio.addEventListener('play', ()=> setBtn(false));
        video.addEventListener('pause', ()=> setBtn(true));
        audio.addEventListener('pause', ()=> setBtn(true));

        tryAutoStart();
        requestAnimationFrame(syncLoop);
      })();
    </script>
  </body>
</html>
